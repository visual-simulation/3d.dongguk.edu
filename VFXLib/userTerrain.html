<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace;
            background-color: #f0f0f0;
            margin: 0px;
            overflow: hidden;
        }
    </style>
</head>
<body>

<script src="./lib/three/build/three.min.js"></script>
<script src="./lib/three/examples/js/libs/stats.min.js"></script>
<script type="text/javascript" src="./dat.gui.min.js"></script>

<script src="./lib/three/examples/js/controls/OrbitControls.js"></script>
<script src="./lib/three/examples/js/controls/TrackballControls.js"></script>

<script src="./ParticleSystem.js"></script>
<script src="./paticleParameter.js"></script>
<script src="./FlowTexture.js"></script>
<script src="./AdditiveTerrain.js"></script>


<script>

    var container, stats;
    var camera, scene, projector, renderer;
    var mesh, animation;

    var ps;

    var gui;
    var controls;


    var mouse = new THREE.Vector2();
    var index = new THREE.Vector2();
    var mouseVel = 0.0;

    var offset = new THREE.Vector3();

    var raycaster = new THREE.Raycaster();

    var objects = [];
    var plane = new THREE.Mesh(
            new THREE.PlaneBufferGeometry( 10000, 10000, 8, 8 ),
            new THREE.MeshBasicMaterial( { visible: false } )
    );

    var selected = false;


    particleSystem = new ParticleSystem();


    var psParams = {blendingType : THREE.NormalBlending};

    particleSystem.initialize(1000, psParams);

    particleSystem.setParameters({
        seedVelDir: new THREE.Vector3(0.0,-1,0),
        seedVelMag: 120.0,
        globalForce: new THREE.Vector3(0, -0.1, 0),
        windStrength: 10,
        seedSize: 60,
        seedLife: 5.0,
        texFile: "./textures/leaf.png",
        particleColor: new THREE.Color(0Xaaaa00),
        angularVel : 0.005,
        alpha: 1.0,
    });


    var terrain = new AdditiveTerrain();

    var min = new THREE.Vector3(-2000.0, 0.0, -2000.0);
    var max = new THREE.Vector3( 2000.0, 0.0,  2000.0);

    var terrainParams = {terrainImage:"./textures/grass.jpg",
                         terrainImage1:"./textures/desert5.jpg",
                         decalImage:"./textures/leaf.png", decalColor:0xffaa00};

    terrain.initialize(min, max, 200, 200, 10000, 20, terrainParams);


    init();
    //animate();
    loop();

    function init() {

        container = document.createElement( 'div' );
        document.body.appendChild( container );

        var info = document.createElement( 'div' );
        info.style.position = 'absolute';
        info.style.top = '10px';
        info.style.width = '100%';
        info.style.textAlign = 'center';

        container.appendChild( info );

        //

        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.setLens(18);

        camera.position.y = 200;
        camera.position.x = 200;
        camera.position.z = 500;

        scene = new THREE.Scene();
        scene.fog = new THREE.Fog( 0x59472b, 1, 10000 );

        //

        var light = new THREE.DirectionalLight( 0xefefff, 2 );
        light.position.set( 1, 1, 1 ).normalize();
        light.castShadow = true;
        scene.add( light );


        var light = new THREE.DirectionalLight( 0xffefef, 2 );
        light.position.set( -1, -1, -1 ).normalize();
        light.castShadow = true;
        scene.add( light );

        //terrain.addDecal(new THREE.Vector3(0.0, 0.0, 0.0));

        objects.push(terrain.getMesh());

        scene.add(plane);
        scene.add(terrain.getMesh());
        scene.add(terrain.getDecalMesh());
        scene.add(particleSystem.getMesh());

        //

        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setClearColor( scene.fog.color );
        //renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        container.appendChild(renderer.domElement);

        //

        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        //container.appendChild( stats.domElement );


        controls = new THREE.OrbitControls(camera, renderer.domElement);
/*
        controls.rotateSpeed = 10.0;
        controls.zoomSpeed = 5;
        controls.panSpeed = 2;

        controls.noZoom = false;
        controls.noPan = false;

        controls.staticMoving = true;
        controls.dynamicDampingFactor = 0.3;
*/
        //

        window.addEventListener( 'resize', onWindowResize, false );

        renderer.domElement.addEventListener('mousemove', onDocumentMouseMove, false);
        renderer.domElement.addEventListener('mousedown', onDocumentMouseDown, false);
        renderer.domElement.addEventListener('mouseup'  , onDocumentMouseUp  , false);

    }

    function onDocumentMouseMove(event) {

        event.preventDefault();

        var tempY = mouse.y;

        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

        mouseVel = mouse.y - tempY;


        raycaster.setFromCamera( mouse, camera );

        if(selected == true) {

            var intersects = raycaster.intersectObject( plane );

            if(intersects.length > 0) {

                terrain.setHeight(parseInt(index.x), parseInt(index.y), mouseVel*500.0);

            }
        }
    }

    function onDocumentMouseDown(event) {

        event.preventDefault();

        raycaster.setFromCamera( mouse, camera );

        var intersects = raycaster.intersectObjects(objects);

        if(intersects.length > 0) {

            controls.enabled = false;
            selected = true;

            plane.position.copy(intersects[0].point);
            plane.lookAt(camera.position);

            index = terrain.getIndex(intersects[0].point);
        }
    }

    function onDocumentMouseUp(event) {

        event.preventDefault();

        controls.enabled = true;

        selected = false;

    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );
    }

    //
    var fps = 40;
    var time;
    var accTime = 0.0;

    function loop() {

        setTimeout(loop, 1000/fps);

        var now = new Date().getTime();
        var dt = (now - (time||now))/1000;
        time = now;

        accTime += dt;

        stats.begin();


        var cen = new THREE.Vector3(0,500,0);
        var nor = new THREE.Vector3(0,-1,0);
        var rad = 500;


        particleSystem.addParticlesFromDisk(2, cen, nor, rad);
        particleSystem.updateParticles(dt, terrain);


        controls.update();

        requestAnimationFrame(render);

        stats.end();
    }

    function render() {
        renderer.render( scene, camera );
    }

</script>

</body>
</html>
