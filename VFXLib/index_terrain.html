<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

    <script src="./lib/three/build/three.min.js"></script>
    <script src="./lib/three/examples/js/controls/TrackballControls.js"></script>
    <script src="./lib/three/examples/js/SkyShader.js"></script>


    <script src="./lib/three/examples/js/loaders/VRMLLoader.js"></script>
    <script src="./lib/three/examples/js/loaders/OBJLoader.js"></script>

    <script src="./Grid.js"></script>
    <script src="./ObjectField.js"></script>

    <script src="./ParticleSystem.js"></script>
    <script src="./lib/Stats.js"></script>
    <script src="./dat.gui.min.js"></script>

    <script src="./TerrainNoise.js"></script>
    <script src="./Terrain.js"></script>
</head>
<body>

    <script>

        var clock = new THREE.Clock();

        var stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '0px';
        stats.domElement.style.top = '0px';
        stats.domElement.style.width = '90px'
        document.body.appendChild(stats.domElement);


        var grid = new Grid();
        grid.initialize(4, 4, 4, new THREE.Vector3(-10000.0, -10000.0, -10000.0), new THREE.Vector3(10000.0, 10000.0, 10000.0));

        var field = new ObjectField();
        field.initialize(grid);

        var idx = grid.getCellIndex(new THREE.Vector3(0,0,0));

        var scene, camera, renderer;
        var controls;

        var particleSystem;
        var particleSystemFire;

        var terrain;
        var sky, sunSphere;

        var animation;

        function init() {

            var noise = new TerrainNoise();
            terrain = new Terrain();
            terrain.initialize( noise, 1024, 4, 64 );

            renderer = new THREE.WebGLRenderer( { antialias: true } );
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0xaaaaaa);

            document.body.appendChild(renderer.domElement);

            //
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000000 );
            camera.position.y = 300;
            camera.position.x = 300;
            camera.position.z = 700;

            controls = new THREE.TrackballControls( camera, renderer.domElement );

            controls.rotateSpeed = 10.0;
            controls.zoomSpeed = 5;
            controls.panSpeed = 2;

            controls.noZoom = false;
            controls.noPan = false;

            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;

            window.addEventListener( 'resize', onWindowResize, false );

            particleSystem = new ParticleSystem();
            particleSystem.initialize(10000);

            particleSystemFire = new ParticleSystem();
            particleSystemFire.initialize(10000);

            scene = new THREE.Scene();

            scene.add(particleSystem.getMesh());
            scene.add(particleSystemFire.getMesh());

            scene.add(terrain.getMesh());


            var loader = new THREE.JSONLoader( true );
            loader.load( "./models/sittingBox.json", function( geometry ) {

                mesh = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial( { color: 0x606060, morphTargets: true, side:THREE.DoubleSide } ) );
                mesh.scale.set(300,300,300);
                mesh.position.set(0,0,-400);

                scene.add( mesh );

                animation = new THREE.MorphAnimation( mesh );
                animation.play();
            } );

            // Loader
            var loader = new THREE.OBJLoader();
            loader.load("models/campfire.obj", function(object){

                var material = new THREE.MeshPhongMaterial( { color: 0x111111, specular: 0x111111, shininess: 30 });
                material.side = THREE.DoubleSide;

                object.traverse( function ( child ) {

                    if ( child instanceof THREE.Mesh ) {

                        child.material = material;
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                object.position.y = 10;
                object.scale.set(3, 3, 3);
                scene.add(object);
            });


            var helper = new THREE.GridHelper( 5000, 5000 );
            helper.color1.setHex( 0xffffff );
            helper.color2.setHex( 0xffffff );
            scene.add( helper );





            initSky();

            // Lights
            scene.add( new THREE.AmbientLight( 0x777777 ) );

            addShadowedLight( 1, 1, 1, 0xffffff, 1.35 );
            addShadowedLight( 0.5, 1, -1, 0xffaa00, 1 );


            particleSystem.setParameters({
                seedVelDir: new THREE.Vector3(0.3,-1,0),
                seedVelMag: 500.0,
                globalForce: new THREE.Vector3(0, -0.1, 0),
                windStrength: 50,
                seedSize: 10,
                seedLife: 2.0,
                texFile : "./textures/snowflake.png",
                particleColor: new THREE.Color(0Xfffafa),
                alpha : 1.0
            });

            particleSystemFire.setParameters({
                seedVelDir: new THREE.Vector3(0, 1, 0),
                seedVelMag: 1000.0,
                globalForce: new THREE.Vector3(0, 10, 0),
                windStrength: 30,
                seedSize: 200,
                seedLife: 0.5,
                texFile : "./textures/flame.png",
                particleColor: new THREE.Color(1,0.2,0.2),
                alpha : 5.0
            });

            var gui, ParamConfig = {
                seedVelMag : 500.0,
                seedLife : 40.0,
                seedSize : 30,
                windStrength: 0,
                globalForceX: 0,
                globalForceY: 0,
                globalForceZ: 0
            };

            gui = new dat.GUI();

            gui.add(ParamConfig, 'seedVelMag', 200, 1000).onChange(function(value){
                particleSystem.setParameters({seedVelMag : value});
            });

            gui.add(ParamConfig, 'seedLife', 1, 2000).onChange(function(value){
                particleSystem.setParameters({seedLife : value});
            });

            gui.add(ParamConfig, 'seedSize', 0, 1000).onChange(function(value){
                particleSystem.setParameters({seedSize : value});
            });

            gui.add(ParamConfig, 'windStrength', 0, 1000).onChange(function(value){
                particleSystem.setParameters({windStrength: value});
            });
        }

        function initSky(){
            // Add Sky Mesh
            sky = new THREE.Sky();

            // Add Sun Helper
            sunSphere = new THREE.Mesh( new THREE.SphereGeometry( 20000, 30, 30 ),
                    new THREE.MeshBasicMaterial({color: 0xffffff, wireframe: false }));
            sunSphere.position.y = -700000;
            sunSphere.visible = true;

            /// GUI
            var effectController  = {
                turbidity: 10,
                reileigh: 2,
                mieCoefficient: 0.005,
                mieDirectionalG: 0.8,
                luminance: 1,
                inclination: 0.49, // elevation / inclination
                azimuth: 0.25, // Facing front,
                sun: !true
            }

            var distance = 400000;

            function guiChanged() {
                var uniforms = sky.uniforms;
                uniforms.turbidity.value = effectController.turbidity;
                uniforms.reileigh.value = effectController.reileigh;
                uniforms.luminance.value = effectController.luminance;
                uniforms.mieCoefficient.value = effectController.mieCoefficient;
                uniforms.mieDirectionalG.value = effectController.mieDirectionalG;

                var theta = Math.PI * (effectController.inclination - 0.5);
                var phi = 2 * Math.PI * (effectController.azimuth - 0.5);

                sunSphere.position.x = distance * Math.cos(phi);
                sunSphere.position.y = distance * Math.sin(phi) * Math.sin(theta);
                sunSphere.position.z = distance * Math.sin(phi) * Math.cos(theta);

                sunSphere.visible = effectController.sun;

                sky.uniforms.sunPosition.value.copy(sunSphere.position);

            }


            var gui = new dat.GUI();
            gui.add( effectController, "turbidity", 1.0, 20.0, 0.1 ).onChange( guiChanged );
            gui.add( effectController, "reileigh", 0.0, 4, 0.001 ).onChange( guiChanged );
            gui.add( effectController, "mieCoefficient", 0.0, 0.1, 0.001 ).onChange( guiChanged );
            gui.add( effectController, "mieDirectionalG", 0.0, 1, 0.001 ).onChange( guiChanged );
            gui.add( effectController, "luminance", 0.0, 2).onChange( guiChanged );;
            gui.add( effectController, "inclination", 0, 1, 0.0001).onChange( guiChanged );
            gui.add( effectController, "azimuth", 0, 1, 0.0001).onChange( guiChanged );
            gui.add( effectController, "sun").onChange( guiChanged );
            guiChanged();
        }

        function addShadowedLight( x, y, z, color, intensity ) {

            var directionalLight = new THREE.DirectionalLight( color, intensity );
            directionalLight.position.set( x, y, z )
            scene.add( directionalLight );

            directionalLight.castShadow = true;
            // directionalLight.shadowCameraVisible = true;

            var d = 1;
            directionalLight.shadowCameraLeft = -d;
            directionalLight.shadowCameraRight = d;
            directionalLight.shadowCameraTop = d;
            directionalLight.shadowCameraBottom = -d;

            directionalLight.shadowCameraNear = 1;
            directionalLight.shadowCameraFar = 4;

            directionalLight.shadowMapWidth = 1024;
            directionalLight.shadowMapHeight = 1024;

            directionalLight.shadowBias = -0.005;
            directionalLight.shadowDarkness = 0.15;
        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        function animate() {

            requestAnimationFrame( animate );

            var cen = new THREE.Vector3(0,500,0);
            var nor = new THREE.Vector3(0,-1,0);
            var rad = 1000;

            particleSystem.addParticlesFromDisk(20, cen, nor, rad);
            particleSystem.updateParticles(clock.getDelta());

            {
                var cen = new THREE.Vector3(0,0,0);
                var nor = new THREE.Vector3(0,1,0);
                var rad = 100;

                particleSystemFire.addParticlesFromDisk(10, cen, nor, rad);
                particleSystemFire.updateParticles(clock.getDelta());

            }

            terrain.update(0, 0);
            controls.update();

            render();
         }

        var prevTime = Date.now();

        function render() {

            if ( animation ) {

                var time = Date.now();

                animation.update( (time - prevTime)*0.1 );

                prevTime = time;

            }

            renderer.render( scene, camera );
            stats.update();


        }

        init();
        animate();
    </script>

</body>
</html>