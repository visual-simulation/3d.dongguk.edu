
<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - PLY</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <script src="./lib/three/build/three.min.js"></script>
    <script src="./lib/three/examples/js/controls/OrbitControls.js"></script>


    <script src="./lib/three/examples/js/Detector.js"></script>
    <script src="./lib/three/examples/js/libs/stats.min.js"></script>
    <script src="./lib/three/examples/js/libs/tween.min.js"></script>

    <script src="./lib/three/examples/js/loaders/VRMLLoader.js"></script>
    <script src="./lib/three/examples/js/loaders/OBJLoader.js"></script>

    <script src="./lib/three/examples/js/shaders/CopyShader.js"></script>
    <script src="./lib/three/examples/js/shaders/BokehShader.js"></script>

    <script src="./lib/three/examples/js/shaders/HorizontalBlurShader.js"></script>
    <script src="./lib/three/examples/js/shaders/VerticalBlurShader.js"></script>

    <script src="./lib/three/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="./lib/three/examples/js/postprocessing/RenderPass.js"></script>
    <script src="./lib/three/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="./lib/three/examples/js/postprocessing/MaskPass.js"></script>
    <script src="./lib/three/examples/js/postprocessing/BokehPass.js"></script>

    <script src="./ParticleSystem.js"></script>
</head>

<body>
    <script>

        if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

        var container, stats;
        var camera, cameraTarget, scene, renderer;

        var ps;

        var fog = new THREE.Fog( 0x72645b, 2, 15 );

        init();
        loop();

        function init() {

            container = document.createElement( 'div' );
            document.body.appendChild( container );

            camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 100 );

            camera.position.y = 0.8;
            camera.position.x = 2.2;
            camera.position.z = 3;

            controls = new THREE.OrbitControls(camera);

            controls.rotateSpeed = 0.3;

            controls.noZoom = true;
            controls.noPan = true;

            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;

            scene = new THREE.Scene();
            scene.fog = fog;

            // initialize particle system;
            ps = new ParticleSystem();
            ps.initialize(10000);

            ps.setParameters({seedVelDir: new THREE.Vector3(0,0,1),
                              seedVelMag: 2.0,
                              globalForce: new THREE.Vector3(0, -10,0),
                              windStrength: 0.05,
                              seedSize: 0.6,
                              seedLife: 2.0,
                              texFile : "./textures/gradient.png",
                              matcapFile: "./textures/matcaps/blue.jpg",
                              particleColor: new THREE.Color(0.1, 0.1, 1.0),
                              alpha : 0.7
            });

            // Ground
            var plane = new THREE.Mesh(
                    new THREE.PlaneBufferGeometry( 40, 40 ),
                    new THREE.MeshPhongMaterial( { color: 0x555555, specular: 0x000000 } )
            );
            plane.rotation.x = -Math.PI/2;
            plane.position.y = -0.5;
            plane.receiveShadow = true;

            scene.add( plane );


            var sphereMesh = new THREE.Mesh(
                    new THREE.SphereGeometry(0.2,100,100),
                    new THREE.MeshPhongMaterial( { color: 0x111111, specular: 0x111111, shininess: 100 } )
            );

            sphereMesh.receiveShadow = true;
            sphereMesh.castShadow = true;
            sphereMesh.position.set(-0.57,-0.4,0.9);

            scene.add( sphereMesh );


            // Loader
            var loader = new THREE.OBJLoader();
            loader.load('./models/pipe.obj', function(object){

                var material = new THREE.MeshPhongMaterial( { color: 0x111111, specular: 0x111111, shininess: 30 });
                material.side = THREE.DoubleSide;

                object.traverse( function ( child ) {

                    if ( child instanceof THREE.Mesh ) {

                        child.material = material;
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                object.position.y = -0.5;
                object.scale.set(0.02, 0.02, 0.02);
                object.rotation.x = -Math.PI*0.5;

                scene.add(object);
            });

            scene.add(ps.getMesh());

            //scene.add(ps.getScreenMesh());

            //
            var objectField = new ObjectField();
            objectField.initialize();

            var planeObject = new PlaneObject();
            planeObject.initialize(new THREE.Vector3(0,-0.5,0), new THREE.Vector3(0,1,0));
            planeObject.setParameters(0.3, 0.8);

            objectField.addObstacle(planeObject);


            var sphereObject = new SphereObject();
            sphereObject.initialize(new THREE.Vector3(-0.57,-0.4,0.9), 0.2);
            sphereObject.setParameters(0.3, 0.8);


            objectField.addObstacle(sphereObject);


            ps.setObstacleField(objectField);

            // Lights

            scene.add( new THREE.AmbientLight( 0x777777 ) );

            addShadowedLight( 1, 1, 1, 0xffffff, 1.35 );
            addShadowedLight( 0.5, 1, -1, 0xffaa00, 1 );

            // renderer

            renderer = new THREE.WebGLRenderer( { antialias: true, alpha:true } );
            renderer.setClearColor( fog.color, 0.0 );
            renderer.setSize( window.innerWidth, window.innerHeight );

            renderer.gammaInput = true;
            renderer.gammaOutput = true;
            renderer.shadowMapEnabled = true;
            renderer.shadowMapCullFace = THREE.CullFaceBack;

            container.appendChild( renderer.domElement );

            // stats

            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '0px';
            container.appendChild( stats.domElement );

            // resize

            window.addEventListener( 'resize', onWindowResize, false );
        }

        function addShadowedLight( x, y, z, color, intensity ) {

            var directionalLight = new THREE.DirectionalLight( color, intensity );
            directionalLight.position.set( x, y, z )
            scene.add( directionalLight );

            directionalLight.castShadow = true;
            // directionalLight.shadowCameraVisible = true;

            var d = 1;
            directionalLight.shadowCameraLeft = -d;
            directionalLight.shadowCameraRight = d;
            directionalLight.shadowCameraTop = d;
            directionalLight.shadowCameraBottom = -d;

            directionalLight.shadowCameraNear = 1;
            directionalLight.shadowCameraFar = 4;

            directionalLight.shadowMapWidth = 1024;
            directionalLight.shadowMapHeight = 1024;

            directionalLight.shadowBias = -0.005;
            directionalLight.shadowDarkness = 0.15;

        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );

        }

        var fps = 40;
        var time;
        function loop() {

            setTimeout(loop, 1000/fps);

            var now = new Date().getTime();
            var dt = (now - (time||now))/1000;
            time = now;


            stats.begin();

            var cen = new THREE.Vector3(-0.57,0.24,0.24);
            var rad = 0.11;

            ps.addParticlesFromSphere(50, cen, rad);
            ps.updateParticles(dt);
            controls.update();

            requestAnimationFrame(render);

            stats.end();
        }

        function render() {

            renderer.setClearColor( fog.color, 0.0 );
            ps.updateTexture(renderer, camera);

            renderer.setClearColor( fog.color, 1.0 );
            renderer.render(scene, camera);

        }

    </script>

</body>
