<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

    <script src="./lib/three/build/three.min.js"></script>
    <script src="./lib/three/examples/js/controls/TrackballControls.js"></script>
    <script src="./lib/three/examples/js/SkyShader.js"></script>

    <script src="./SphereObject.js"></script>
    <script src="./PlaneObject.js"></script>
    <script src="./Grid.js"></script>
    <script src="./ObjectField.js"></script>

    <script src="./ParticleSystem.js"></script>
    <script src="./lib/Stats.js"></script>
    <script src="./dat.gui.min.js"></script>

    <script src="./TerrainNoise.js"></script>
    <script src="./Terrain.js"></script>
</head>
<body>

    <script>

        var clock = new THREE.Clock();

        var stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '0px';
        stats.domElement.style.top = '0px';
        stats.domElement.style.width = '90px'
        document.body.appendChild(stats.domElement);


        var grid = new Grid();
        grid.initialize(4, 4, 4, new THREE.Vector3(-10000.0, -10000.0, -10000.0), new THREE.Vector3(10000.0, 10000.0, 10000.0));

        var field = new ObjectField();
        field.initialize(grid);

        var idx = grid.getCellIndex(new THREE.Vector3(0,0,0));

        var scene, camera, renderer;
        var controls;

        var particleSystem;
        var terrain;
        var sky, sunSphere;

        function init() {

            var noise = new TerrainNoise();
            terrain = new Terrain();
            terrain.initialize( noise, 1024, 4, 64 );

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0xaaaaaa);

            document.body.appendChild(renderer.domElement);

            //
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000000 );
            camera.position.z = 2000;

            controls = new THREE.TrackballControls( camera, renderer.domElement );

            controls.rotateSpeed = 10.0;
            controls.zoomSpeed = 5;
            controls.panSpeed = 2;

            controls.noZoom = false;
            controls.noPan = false;

            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;

            window.addEventListener( 'resize', onWindowResize, false );

            particleSystem = new ParticleSystem();
            particleSystem.initialize(100000);

            scene = new THREE.Scene();
            scene.add(particleSystem.getMesh());
            scene.add(terrain.getMesh());
         // scene.add(grid.getMesh());

            var helper = new THREE.GridHelper( 5000, 5000 );
            helper.color1.setHex( 0xffffff );
            helper.color2.setHex( 0xffffff );
            scene.add( helper );

            initSky();

            // Lights
            scene.add( new THREE.AmbientLight( 0x777777 ) );

            addShadowedLight( 1, 1, 1, 0xffffff, 1.35 );
            addShadowedLight( 0.5, 1, -1, 0xffaa00, 1 );


            var gui, ParamConfig = {
                seedVelDir : new THREE.Vector3(0.7, -2, 0),
                seedVelMag : 500.0,
                seedLife : 1000,
                seedSize : 200,
                seedSpread : 0.15,
                colorBase : new THREE.Color(0Xfffafa),
                tex : THREE.ImageUtils.loadTexture("./textures/snowflake.png")
            };

            gui = new dat.GUI();

            gui.add(ParamConfig, 'seedVelMag', 200, 1000).onChange(function(value){
                var velMag = {seedVelMag : value};
                particleSystem.setParameters(velMag);
            });

            gui.add(ParamConfig, 'seedLife', 1, 2000).onChange(function(value){
                var life = {seedLife : value};
                particleSystem.setParameters(life);
            });

            gui.add(ParamConfig, 'seedSize', 100, 1000).onChange(function(value){
                var seed = {seedSize : value};
                particleSystem.setParameters(seed);
            });

            gui.add(ParamConfig, 'seedSpread', 0.1, 4.0).onChange(function(value){
                var spread = {seedSpread : value};
                particleSystem.setParameters(spread);
            });
        }

        function initSky(){
            // Add Sky Mesh
            sky = new THREE.Sky();
            scene.add( sky.mesh );

            // Add Sun Helper
            sunSphere = new THREE.Mesh( new THREE.SphereGeometry( 20000, 30, 30 ),
                    new THREE.MeshBasicMaterial({color: 0xffffff, wireframe: false }));
            sunSphere.position.y = -700000;
            sunSphere.visible = true;
            scene.add( sunSphere );

            /// GUI
            var effectController  = {
                turbidity: 10,
                reileigh: 2,
                mieCoefficient: 0.005,
                mieDirectionalG: 0.8,
                luminance: 1,
                inclination: 0.49, // elevation / inclination
                azimuth: 0.25, // Facing front,
                sun: !true
            }

            var distance = 400000;

            function guiChanged() {
                var uniforms = sky.uniforms;
                uniforms.turbidity.value = effectController.turbidity;
                uniforms.reileigh.value = effectController.reileigh;
                uniforms.luminance.value = effectController.luminance;
                uniforms.mieCoefficient.value = effectController.mieCoefficient;
                uniforms.mieDirectionalG.value = effectController.mieDirectionalG;

                var theta = Math.PI * (effectController.inclination - 0.5);
                var phi = 2 * Math.PI * (effectController.azimuth - 0.5);

                sunSphere.position.x = distance * Math.cos(phi);
                sunSphere.position.y = distance * Math.sin(phi) * Math.sin(theta);
                sunSphere.position.z = distance * Math.sin(phi) * Math.cos(theta);

                sunSphere.visible = effectController.sun;

                sky.uniforms.sunPosition.value.copy(sunSphere.position);

            }


            var gui = new dat.GUI();
            gui.add( effectController, "turbidity", 1.0, 20.0, 0.1 ).onChange( guiChanged );
            gui.add( effectController, "reileigh", 0.0, 4, 0.001 ).onChange( guiChanged );
            gui.add( effectController, "mieCoefficient", 0.0, 0.1, 0.001 ).onChange( guiChanged );
            gui.add( effectController, "mieDirectionalG", 0.0, 1, 0.001 ).onChange( guiChanged );
            gui.add( effectController, "luminance", 0.0, 2).onChange( guiChanged );;
            gui.add( effectController, "inclination", 0, 1, 0.0001).onChange( guiChanged );
            gui.add( effectController, "azimuth", 0, 1, 0.0001).onChange( guiChanged );
            gui.add( effectController, "sun").onChange( guiChanged );
            guiChanged();

            camera.lookAt(sunSphere.position)
        }

        function addShadowedLight( x, y, z, color, intensity ) {

            var directionalLight = new THREE.DirectionalLight( color, intensity );
            directionalLight.position.set( x, y, z )
            scene.add( directionalLight );

            directionalLight.castShadow = true;
            // directionalLight.shadowCameraVisible = true;

            var d = 1;
            directionalLight.shadowCameraLeft = -d;
            directionalLight.shadowCameraRight = d;
            directionalLight.shadowCameraTop = d;
            directionalLight.shadowCameraBottom = -d;

            directionalLight.shadowCameraNear = 1;
            directionalLight.shadowCameraFar = 4;

            directionalLight.shadowMapWidth = 1024;
            directionalLight.shadowMapHeight = 1024;

            directionalLight.shadowBias = -0.005;
            directionalLight.shadowDarkness = 0.15;
        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );
        }

        function animate() {

            requestAnimationFrame( animate );

            var cen = new THREE.Vector3(0,10000,0);
            var nor = new THREE.Vector3(0,-1,0);
            var rad = 10000;
            particleSystem.addParticlesFromDisk(100, cen, nor, rad);
            particleSystem.updateParticles(clock.getDelta());

            controls.update();

            render();
         }

        function render() {
//          renderer.clear();
//          renderer.clearDepth();
            renderer.render( scene, camera );
            stats.update();
        }

        init();
        animate();
    </script>

</body>
</html>